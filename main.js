import*as M from"./snowpack/env.js";import.meta.env=M;import{Pane as _}from"./snowpack/pkg/tweakpane.js";import{askWorker as F,sendWorker as v,descriptForWorker as i}from"./utils/common.js";import{jsonCopy as q}from"./snowpack/pkg/ish-utils/common.js";import{lerp as W,invlerp as z}from"./snowpack/pkg/ish-utils/math.js";import T from"./utils/qs.js";import{MicAnalyzer as D,drawSpectrum as L}from"./utils/Audio.js";import{SketchControls as N,Presets as U}from"./utils/Pane.js";import G from"./utils/Sketch.js";import H from"./utils/Offscreen.js";import E from"./palletes.js";import A from"./defaultPresets.js";const w="Default",o=new Worker(new URL("./worker.js",import.meta.url),{name:"circlesWorker",type:"module"});let mt=3;const g=document.querySelector("#MorphParams"),I=document.querySelector("#EdgeDetectParams"),f=[7,10];let pt=!1,C=!1,K,B,t={};const a=new G({fullwidth:!0,bindKeys:{p(e){c.expanded=!c.expanded,a.$stats.style.display=c.expanded?"inline-block":"none"},o(e){s.expanded=!s.expanded},i(e){n.expanded=!n.expanded},u(e){x.expanded=!x.expanded},b(e){b()},f(e){(C=!C)?document.body.requestFullscreen():document.exitFullscreen()},q(e){S()},"/":b},onResize({width:e,height:r}){K=e,B=r,v.call(o,"resize",{width:e,height:r})}});window.$art=a;const J=A[w];t={get morphRad(){return(g.getAttribute("operator")==="dilate"?1:-1)*Math.abs(parseFloat(g.getAttribute("radius")))},set morphRad(e){return g.setAttribute("operator",e>0?"dilate":"erode"),g.setAttribute("radius",e.toFixed(3)),console.log("set morphRad",e),e},get edgeRad(){return parseFloat(I.getAttribute("kernelMatrix").split(" ")[4])},set edgeRad(e){const r=I.getAttribute("kernelMatrix").split(" ");return e===f[0]?e=0:e===(f[0]+f[1])/2&&(e=e+.001),r[4]=e,console.log("set edgeRad",e),I.setAttribute("kernelMatrix",r.join(" "))}},Object.assign(t,q(J)),i(o,"params",t,"attract"),i(o,"params",t,"distance"),i(o,"params",t,"flock"),i(o,"params",t,"align"),i(o,"params",t,"mult"),i(o,"params",t,"mirrorEdges"),i(o,"params",t,"amount"),i(o,"params",t,"wind"),i(o,"params",t,"gravity"),i(o,"params",t,"turbulence"),i(o,"params",t,"turbMorph");const c=window.$pane=new _,l=c.addFolder({title:"Preferences [P]"}),V=new U({pane:c,defaultPresets:A,folder:l,defaultPresetName:w}),{toggleRecording:S}=new N(l,a,b);t.hasOwnProperty("micOn")||(t.micOn=!0),l.addInput(t,"micOn");const u=.001,s=l.addFolder({title:"Effects [O]"});s.addInput(t,"translate",{x:{min:-5,max:5},y:{min:-5,max:5}}),s.addInput(t,"contrast",{min:0,max:3,step:u}),s.addInput(t,"invContrast"),s.addInput(t,"blur",{min:0,max:10,step:u}),s.addInput(t,"opacity",{min:0,max:1,step:u}),s.addInput(t,"opacityCanv",{min:0,max:1,step:u}),s.addInput(t,"morphRad",{min:-10,max:10,step:u}),s.addInput(t,"edgeRadOn"),s.addInput(t,"edgeRad",{min:f[0],max:f[1],step:u}),s.addSeparator();const n=l.addFolder({title:"Particles [I]",expanded:!1});n.addInput(t,"color",{options:Object.keys(E).map(e=>({text:e,value:e}))}),n.addInput(t,"size",{min:0,max:6}),n.addInput(t,"attract"),n.addInput(t,"amount",{min:0,max:1e3,step:1}),n.addInput(t,"flock",{min:0,max:2}),n.addInput(t,"align",{min:0,max:2}),n.addInput(t,"distance",{min:15,max:150}),n.addInput(t,"mult",{min:0,max:10}),n.addInput(t,"mirrorEdges"),n.addInput(t,"wind",{min:-3,max:3}),n.addInput(t,"gravity",{min:-3,max:3}),n.addInput(t,"turbulence"),n.addInput(t,"turbMorph",{min:0,max:300});const x=l.addFolder({title:"Vibrations (Freq / Amp) [U]"});x.addInput(t,"contrastVibr",{x:{min:0,max:3},y:{min:0,max:3}}),x.addInput(t,"blurVibr",{x:{min:0,max:3},y:{min:0,max:3}}),x.addInput(t,"sizeVibr",{x:{min:0,max:50},y:{min:0,max:3}});let P=V.list[V.current];P||(P=V.list[w],console.log("main.js",l)),c.importPreset(P);function Q(e,r){e.beginPath();const h=E[t.color];e.strokeStyle=h[r.id%h.length]+"66",e.moveTo(r.lastPos.x,r.lastPos.y);const p=(t.micOn?y.avgVol*15-2:0)+t.size+Math.sin(a.iters/100*t.sizeVibr.x+r.id/10)*t.sizeVibr.y;e.lineCap=p>2?"round":"butt",e.lineWidth=p*2,p>0&&(e.lineTo(r.pos.x,r.pos.y),e.stroke()),e.closePath()}const j=new H({parent:a,padding:50,real:!1});window.$feedback=j;function b(){j.clear(),a.clear(),F.call(o,"init",{width:a.W,height:a.H,amount:t.amount,arrangement:"voidCircle"}).then(e=>a.animate(X,e))}const O=new D;O.onReady=b;const ct=document.querySelector("#TurbOffsetParams"),ut=document.querySelector("#TurbParams"),y={avgVol:0,minVol:0,dynVol:0};let m=0;function X(e,r){const h=Date.now(),R=F.call(o,"update",{mouse:a.mouse}),p=t.contrast+Math.sin(e.iters/100*t.contrastVibr.x)*t.contrastVibr.y,$=t.blur+Math.sin(a.iters/100*t.blurVibr.x)*t.blurVibr.y;if(t.micOn){const d=O.getVol(a.iters);m+=d<m?(d-m)/1:(d-m)/100,y.minVol=m;const k=y.avgVol=z(Math.min(.5,m+.03),1,W(0,1,d));y.dynVol=k-m}return j.letThrough(`blur(${$}px) contrast(${p}) contrast(${1/(t.invContrast?p:1)}) opacity(${t.opacity})`,null,({ctx:d})=>{a.ctx.translate(t.translate.x,t.translate.y),a.ctx.filter=`url(#Morph) ${t.edgeRadOn?"url(#EdgeDetect)":""} opacity(${t.opacityCanv})`}),t.micOn&&L(a,O.freqData,480),a.ctx.setTransform(1,0,0,1,0,0),a.ctx.filter="none",r.forEach((d,k)=>Q(a.ctx,d,k)),R}T.get("record")&&S();export default null;
