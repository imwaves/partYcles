import r from"../snowpack/pkg/ish-utils/PVector.js";import{debounce as u}from"../snowpack/pkg/ish-utils/common.js";const d={s:"savePng"," ":"togglePause"};export default class m{constructor(t={}){let{$el:e,fullwidth:n=!0,autoclear:a,bindKeys:s,alpha:o=!0,smoothing:l=!1}=t;this.opts=t,this.fullwidth=n,this.pause=!1,this.iters=0,this.bindKeys=Object.assign({},d,s),this.now=Date.now(),this.perfStr="",this.$stats=document.querySelector("#stats"),e||(e=document.createElement("canvas"),document.body.appendChild(e)),this.$canvas=e instanceof HTMLCanvasElement?e:document.querySelector(e),this.$canvas.id="canvas",this.$canvas.classList.add("Sketch"),this.ctx=this.$canvas.getContext("2d",{alpha:o}),this.ctx.imageSmoothingEnabled=!!l,l&&(this.ctx.imageSmoothingQuality=l),w(this),this.onResize(),this.animate=this.animate.bind(this),window.addEventListener("resize",u(this.onResize.bind(this),200)),window.addEventListener("keydown",h=>{const c=this.bindKeys[h.key];c&&(h.preventDefault(),c instanceof Function?c.call(this,h):this[c](h))})}bindShortcut(t,e){const n=t.split("+")}onResize(t){console.log("Sketch::onResize",t),this.$canvas.width=this.W=this.fullwidth?window.innerWidth:this.opts.width,this.$canvas.height=this.H=this.fullwidth?window.innerHeight:this.opts.height,this.opts.onResize&&this.opts.onResize({width:this.W,height:this.H})}savePng(){const t=this.$canvas.toDataURL("image/png"),e=document.createElement("a");e.href=t,e.setAttribute("download","yeah-"+Date.now().toString()),e.click()}togglePause(t){this.pause=!this.pause}putImage(t,e,n){const{padding:a=0}=t.opts,{width:s,height:o}=this.$canvas;this.ctx.filter=e||"none",this.ctx.globalCompositeOperation=n||"source-over",this.ctx.drawImage(t.$canvas,a,a,s,o,0,0,s,o),this.ctx.filter="none"}clear(t="black"){if(t===!0){this.ctx.clearRect(0,0,this.$canvas.width,this.$canvas.height);return}this.ctx.fillStyle=this.opts.refill||t,this.ctx.rect(0,0,this.$canvas.width,this.$canvas.height),this.ctx.fill(),this.ctx.fillStyle="none"}async animate(t,e){if(this.now=Date.now(),this.iters%30==0&&(this.$stats.textContent=Math.round(1/((this.now-this.lastNow)/1e3))+" fps"+this.perfStr),this.pause){this.perfStr="",window.requestAnimationFrame(this.animate.bind(this,t,e));return}this.opts.autoclear&&this.clear(),e=await t(this,e),(this.iters+1)%30==0&&(this.perfStr=" / "+String((Date.now()-this.now)/.16|0).padStart(3,"")+"% cpu"),this.iters++,this.lastNow=this.now,window.requestAnimationFrame(this.animate.bind(this,t,e))}}function w(i){i.mouse=null;const{$canvas:t}=i;window.TouchEvent=window.TouchEvent||e;function e(s){s instanceof TouchEvent?i.mouse=new r(s.touches[0].layerX,s.touches[0].layerY):i.mouse=new r(s.layerX,s.layerY)}t.addEventListener("mousedown",e),t.addEventListener("touchstart",e);function n(s){s.preventDefault(),i.mouse&&(s instanceof TouchEvent?i.mouse=new r(s.touches[0].layerX,s.touches[0].layerY):i.mouse=new r(s.layerX,s.layerY))}t.addEventListener("mousemove",n),t.addEventListener("touchmove",n);function a(s){s.preventDefault(),i.mouse=null}t.addEventListener("mouseup",a),t.addEventListener("touchend",a)}
