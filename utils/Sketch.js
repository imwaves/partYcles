import l from"../snowpack/pkg/ish-utils/PVector.js";import{debounce as r}from"../snowpack/pkg/ish-utils/common.js";const u={s:"savePng"," ":"togglePause"};export default class m{constructor(t={}){let{$el:e,fullwidth:n=!0,autoclear:a,bindKeys:s,alpha:h=!0,smoothing:d=!1}=t;this.opts=t,this.fullwidth=n,this.pause=!1,this.iters=0,this.bindKeys=Object.assign({},u,s),this.now=Date.now(),this.perfStr="",e||(e=document.createElement("div"),e.className="sk-cont",document.body.appendChild(e)),this.$el=e,this.$stats=document.createElement("div"),this.$stats.className="sk-stats",this.$el.appendChild(this.$stats),this.$canvas=document.createElement("canvas"),this.$el.appendChild(this.$canvas),this.$canvas.className="sk-canvas",this.ctx=this.$canvas.getContext("2d",{alpha:h}),this.ctx.imageSmoothingEnabled=!!d,d&&(this.ctx.imageSmoothingQuality=d),w(this),this.onResize(),this.animate=this.animate.bind(this),window.addEventListener("resize",r(this.onResize.bind(this),200)),window.addEventListener("keydown",o=>{const c=this.bindKeys[o.key];c&&(o.preventDefault(),c instanceof Function?c.call(this,o):this[c](o))})}onResize(t){console.log("Sketch::onResize",t),this.$canvas.width=this.W=this.fullwidth?window.innerWidth:this.opts.width,this.$canvas.height=this.H=this.fullwidth?window.innerHeight:this.opts.height,this.opts.onResize&&this.opts.onResize({width:this.W,height:this.H})}savePng(){const t=this.$canvas.toDataURL("image/png"),e=document.createElement("a");e.href=t,e.setAttribute("download","yeah-"+Date.now().toString()),e.click()}togglePause(t){this.pause=!this.pause}putImage(t,e,n){const{padding:a=0}=t.opts,{width:s,height:h}=this.$canvas;this.ctx.filter=e||"none",this.ctx.globalCompositeOperation=n||"source-over",this.ctx.drawImage(t.$canvas,a,a,s,h,0,0,s,h),this.ctx.filter="none"}clear(t="black"){if(t===!0){this.ctx.clearRect(0,0,this.$canvas.width,this.$canvas.height);return}this.ctx.fillStyle=this.opts.refill||t,this.ctx.rect(0,0,this.$canvas.width,this.$canvas.height),this.ctx.fill(),this.ctx.fillStyle="none"}async animate(t,e){if(this.now=Date.now(),this.iters%30==0&&(this.$stats.textContent=Math.round(1/((this.now-this.lastNow)/1e3))+" fps"+this.perfStr),this.pause){this.perfStr="",window.requestAnimationFrame(this.animate.bind(this,t,e));return}this.opts.autoclear&&this.clear(),e=await t(this,e),(this.iters+1)%30==0&&(this.perfStr=" / "+String((Date.now()-this.now)/.16|0).padStart(3,"")+"% cpu"),this.iters++,this.lastNow=this.now,window.requestAnimationFrame(this.animate.bind(this,t,e))}}function w(i){i.mouse=null;const{$canvas:t}=i;window.TouchEvent=window.TouchEvent||e;function e(s){s instanceof TouchEvent?i.mouse=new l(s.touches[0].layerX,s.touches[0].layerY):i.mouse=new l(s.layerX,s.layerY)}t.addEventListener("mousedown",e),t.addEventListener("touchstart",e);function n(s){s.preventDefault(),i.mouse&&(s instanceof TouchEvent?i.mouse=new l(s.touches[0].layerX,s.touches[0].layerY):i.mouse=new l(s.layerX,s.layerY))}t.addEventListener("mousemove",n),t.addEventListener("touchmove",n);function a(s){s.preventDefault(),i.mouse=null}t.addEventListener("mouseup",a),t.addEventListener("touchend",a)}
